<!DOCTYPE html>
<html lang="en">

<head>
    <title>Sobre <%= title %>
    </title>
    <link rel="icon" href="/images/favicon.png" type="image/x-icon"><!-- Favicon -->
    <link rel="stylesheet" href="/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" href="/stylesheets/font/bootstrap-icons.css"> <!-- Iconos -->
    <link rel="stylesheet" href="/stylesheets/estilos_horario.css"> <!-- Estilos del horario en public -->
    <script src="/sweetalert2/sweetalert2.all.min.js"></script> <!-- Alertas -->
</head>

<body>
    <%- include("../plantillas/header_trabajadores.ejs") %>

<!--     <h2 class="titulo bg-primary text-white p-2 m-2 rounded"> Horario del trabajador </h2>
 -->

        <% 
            const algo = ['10:00:00', '11:00:00', '12:00:00', '13:00:00', '14:00:00','14:30:00', '15:00:00', '16:00:00', '17:00:00', '18:00:00', '19:00:00', '20:00:00'];
            const horasDelDia = [
            '10:00:00', '10:30:00',
            '11:00:00', '11:30:00',
            '12:00:00', '12:30:00',
            '13:00:00', '13:30:00',
            '14:00:00', '14:30:00',
            '15:00:00', '15:30:00',
            '16:00:00', '16:30:00',
            '17:00:00', '17:30:00',
            '18:00:00', '18:30:00',
            '19:00:00', '19:30:00',
            '20:00:00'
            ];
            const diasLaborables = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
            const horasDeDescanso = ['15:00:00','15:30:00', '16:00:00']; // Estas horas no se trabajan

        %>


    
        <table class="tabla-citas my-3">
            <thead>
                <tr>
                    <th>Hora</th>
                    <!-- Cargar dias y fechas de esos dias -->
                    <% for (let i = 0; i < diasLaborables.length; i++) { %>
                        <th>
                            <%= diasLaborables[i] %><br>
                            <small><%= diasLaborablesSemanaActual[i] %></small>
                        </th>
                    <% } %>
                    </tr>
                </tr>
            </thead>
            <tbody>
                <% horasDelDia.forEach(horaActual => { %>
                    <tr>
                        <td><%= horaActual.substring(0, 5) %></td>
                        <% diasLaborables.forEach((diaActual, index) => {
                            const fechaActual = diasLaborablesSemanaActual[index];
                            let clases = [];
                            let contenidoCelda = '';
            
                            const trabajaEnEstaHora = horarioTrabajador.find(turno =>
                                turno.dia === diaActual &&
                                horaActual >= turno.hora_inicio &&
                                horaActual <= turno.hora_fin // estrictamente menor al fin
                            );
            
                            if (trabajaEnEstaHora) {
                                clases.push('horario-activo');
                            }
            
                            if (horasDeDescanso.includes(horaActual)) {
                                clases.push('descanso');
                            }
            
                            const esVacaciones = vacacionesSemana.includes(fechaActual);
                            const esFestivo = festivosSemana.includes(fechaActual);
            
                            if (esVacaciones) {
                                clases.push('vacaciones');
                                //contenidoCelda = 'Vacaciones';
                            } else if (esFestivo) {
                                clases.push('festivo');
                                //contenidoCelda = 'Festivo';
                            }
            
                            const cita = citasSemana.find(c =>
                                new Date(c.fecha).toLocaleDateString('es-ES') === fechaActual &&
                                c.hora_inicio <= horaActual &&
                                c.hora_fin > horaActual
                            );


            
                            if (cita) {
                                clases.push('cita');
                                contenidoCelda = ''; // vacio y rellenamos en el script de abajo
                            }


                        %>
                        <td class="<%= clases.join(' ') %>" <%= cita ? `data-id=${cita.id_cita}` : '' %>>
                            <%= contenidoCelda %>
                        </td>
                        <% }) %>
                    </tr>


                <% }) %>


            </tbody>
        </table>
            
            
            
            <div id="cuadroCitas">
            </div>


            <div id="contenedorInforme">
            </div>

            <div id="crearCita">
                <a class="cerrado"><strong><i class="bi bi-calendar-plus"></i></strong></a>
                <a class="amplio" href="/zona/trabajador/pacientes"><strong>Crear Cita</strong></a>
            </div>

    <!-- Footer -->
    <%- include("../plantillas/footer.ejs") %>

            <script src="/javascripts/bootstrap.bundle.min.js"></script>
            <script src="/javascripts/funcionesHorarioCitas.js"></script>
            <!-- Para hacer que aparezca dinamicamente la infromación de la cita en el lateral -->

    <script>
        // Inicializamos el Set para almacenar los IDs de citas que ya han sido escritas
        const idsEscritos = new Set();

        // Función que solo escribe el motivo una vez por ID
        function escribirMotivoUnaVez(id, motivo) {
            if (idsEscritos.has(id)) return; // No escribir si ya se ha escrito antes

            // Buscamos la celda con el data-id correspondiente
            const celda = document.querySelector(`[data-id='${id}']`);
            if (celda) {
                celda.textContent = motivo; // Asignamos el motivo a la celda
                idsEscritos.add(id); // Marcamos este ID como escrito
            }
        }

        // Llamamos a la función para cada cita en citasSemana
        const citasSemana = <%- JSON.stringify(citasSemana) %>;
        citasSemana.forEach(cita => {
            escribirMotivoUnaVez(cita.id_cita, cita.motivo); // Escribimos el motivo solo una vez
        });
    </script>


</body>

</html>
