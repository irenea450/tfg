<!DOCTYPE html>
<html lang="es">

<head>
    <title>Citas <%= title %></title>
    <link rel="icon" href="/images/favicon.png" type="image/x-icon"><!-- Favicon -->
    <link rel="stylesheet" href="/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link rel="stylesheet" href="/stylesheets/font/bootstrap-icons.css"> <!-- Iconos -->
    <link rel="stylesheet" href="/stylesheets/estilos_pacientes.css"><!-- estilos comunes en ejs de pacientes -->
    <script src="/sweetalert2/sweetalert2.all.min.js"></script> <!-- alertas -->

</head>

<body class="d-flex flex-column min-vh-100">
    <%- include("../plantillas/header_pacientes.ejs") %>

    <main class="container my-4" style="min-height: 80vh;">

        <!-- Sección de Citas Pendientes -->
        <section class="mb-5">
            <h2 class="titulo bg-primary text-white p-2 rounded"><i class="bi bi-list-task"></i> Citas Pendientes</h2>
            
            <% if (citas && citas.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th class="align-middle">Fecha</th>
                                <th class="align-middle">Hora</th>
                                <th class="align-middle">Motivo</th>
                                <th class="align-middle text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% citas.forEach(cita => { 
                                const fechaFormateada = new Date(cita.fecha).toLocaleDateString('es-ES', {
                                    weekday: 'long',
                                    day: 'numeric',
                                    month: 'long',
                                    year: 'numeric'
                                });
                                const horaFormateada = cita.hora_inicio.substring(0, 5);
                            %>
                                <tr>
                                    <td class="align-middle"><%= fechaFormateada %></td>
                                    <td class="align-middle"><%= horaFormateada %> h</td>
                                    <td class="align-middle"><%= cita.motivo %></td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-outline-danger btn-sm " style="min-width: 100px;" 
                                            onclick="confirmarAnulacion('<%= cita.id_cita %>')">
                                            Anular
                                        </button>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <div class="alert alert-info no-citas">
                    <i class="bi bi-calendar-x"></i> No tienes citas pendientes actualmente
                </div>
            <% } %>
        </section>

        <!-- Sección de Pedir Nueva Cita -->
        <section>
            <h2 class="titulo bg-primary text-white p-2 rounded"><i class="bi bi-calendar-plus"></i> Solicitar Nueva Cita</h2>
            <div class="d-grid gap-2 col-md-6 mx-auto">
                <a href="/zona/paciente/pedirCita" class="btn btn-success btn-lg">
                    Pedir Cita Nueva
                </a>
            </div>
        </section>

        <!-- Formulario oculto para anulación -->
        <form id="formAnular" method="POST" style="display:none;"></form>
    </main>

        <!-- Footer -->
        <%- include("../plantillas/footer.ejs") %>

    <script>
        function confirmarAnulacion(citaId) {
            Swal.fire({
                title: '¿Confirmas que quieres anular esta cita?',
                text: 'Esta acción no se puede deshacer',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, anular',
                cancelButtonText: 'Cancelar',
                backdrop: true,
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/zona/paciente/anular-cita/${citaId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ idCita: citaId })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        Swal.fire({
                            title: '¡Cita anulada!',
                            text: data.mensaje || 'La cita ha sido cancelada correctamente',
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 2000
                        }).then(() => location.reload());
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'No se pudo completar la anulación: ' + error.message,
                            icon: 'error'
                        });
                    });
                }
            });
        }
    </script>

    <script src="/javascripts/bootstrap.bundle.min.js"></script>
</body>
</html>